%!TEX root = ts.tex

\rSec1[Concurrency2.SafeReclamation.rcu]{Read-copy update (RCU)}

\pnum
RCU is a synchronization mechanism that can be used for linked data
structures that are frequently read, but seldom updated.Â  RCU does
not provide mutual exclusion, but instead allows the user to schedule
specified actions such as deletion at some later time.

\pnum
A class type \tcode{T} is \defn{rcu-protectable} if it has exactly one
public base class of type \tcode{rcu_obj_base<T,D>} for some \tcode{D}
and no base classes of type \tcode{rcu_obj_base<X,Y>} for any other
combination \tcode{X}, \tcode{Y}. An object is rcu-protectable if it is
of rcu-protectable type.

\pnum
An invocation of \tcode{unlock U} on an \tcode{rcu_domain dom} corresponds
to an invocation of \tcode{lock L} on \tcode{dom} if \tcode{L} is
sequenced before \tcode{U} and either

\begin{itemize}
\item	no other invocation of \tcode{lock} on \tcode{dom} is sequenced
	after \tcode{L} and before \tcode{U} or
\item	every invocation of \tcode{unlock U'} on \tcode{dom} such
	that \tcode{L} is sequenced before \tcode{U'} and \tcode{U'}
	is sequenced before \tcode{U} corresponds to an invocation of
	\tcode{lock L'} on \tcode{dom} such that \tcode{L} is sequenced
	before \tcode{L'} and \tcode{L'} is sequenced before \tcode{U'}.
\end{itemize}

\pnum
\begin{note}
This pairs nested locks and unlocks on a given domain in each thread.
\end{note}

\pnum
A \defn{region of RCU protection} on a domain \tcode{dom} starts
with a \tcode{lock L} on \tcode{dom} and ends with its corresponding
\tcode{unlock U}.

\pnum
Given a region of RCU protection \tcode{R} on a domain \tcode{dom}
and given an evaluation \tcode{E} that scheduled another evaluation
\tcode{F} in \tcode{dom}, if \tcode{E} does not strongly happen before
the start of \tcode{R}, the end of \tcode{R} strongly happens before
evaluating \tcode{F}.

\pnum
The evaluation of a scheduled evaluation is potentially concurrent with
any other such evaluation. Each scheduled evaluation is evaluated at
most once.

\rSec2[Concurrency2.SafeReclamation.rcu.general]{RCU general}

@@@ Does the text in the above section move here?

\rSec2[Concurrency2.SafeReclamation.rcu.syn]{RCU header \tcode{<rcu>} synopsis}

Editor's note: This section was mistakenly unnumbered in P1122R4.

% @@@ Copy and paste from Google Documents gets space characters and
% @@@ "<>" characters that LaTeX really hates.  Just replace them.

% \indexheader{rcu}%
% @@@ Added missing "," after a number of the references in this code block.
\begin{codeblock}
namespace std::experimental::inline concurrency_v2 {
  // \ref{Concurrency2.SafeReclamation.rcu.base}, class template rcu_obj_base
  template<class T, class D = default_delete<T>>
    class rcu_obj_base;

  // \ref{Concurrency2.SafeReclamation.rcu.domain}, class rcu_domain
  class rcu_domain;

  // \ref{Concurrency2.SafeReclamation.rcu.default.domain}, rcu_default_domain
  rcu_domain& rcu_default_domain() noexcept;

  // \ref{Concurrency2.SafeReclamation.rcu.synchronize}, rcu_synchronize
  void rcu_synchronize(rcu_domain& dom = rcu_default_domain()) noexcept;

  // \ref{Concurrency2.SafeReclamation.rcu.barrier}, rcu_barrier
  void rcu_barrier(rcu_domain& dom = rcu_default_domain()) noexcept;

  // \ref{Concurrency2.SafeReclamation.rcu.retire}, rcu_retire
  template<class T, class D = default_delete<T>>
    void rcu_retire(T* p, D d = D(), rcu_domain& dom = rcu_default_domain());
}
\end{codeblock}

\rSec2[Concurrency2.SafeReclamation.rcu.base]{Class \tcode{rcu_obj_base}}

\rSec2[Concurrency2.SafeReclamation.rcu.domain]{Class \tcode{rcu_domain}}

\rSec3[Concurrency2.SafeReclamation.rcu.domain.lock]{\tcode{rcu_domain::lock}}

\rSec3[Concurrency2.SafeReclamation.rcu.domain.unlock]{\tcode{rcu_domain::unlock}}

\rSec2[Concurrency2.SafeReclamation.rcu.default.domain]{\tcode{rcu_default_domain}}

\rSec2[Concurrency2.SafeReclamation.rcu.synchronize]{\tcode{rcu_synchronize}}

\rSec2[Concurrency2.SafeReclamation.rcu.barrier]{\tcode{rcu_barrier}}

\rSec2[Concurrency2.SafeReclamation.rcu.retire]{Template \tcode{rcu_retire}}
